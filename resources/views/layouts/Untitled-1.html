@extends('layouts.app') {{-- Ensure you have your layout --}}

@section('content')
<div class="restaurant-hero"
     style="background-image: url('{{ $supplier->cover_image ? asset('storage/'.$supplier->cover_image) : asset('images/default-cover.jpg') }}'); background-size: cover; background-position: center; height: 300px; position: relative;">

    <div class="hero-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);"></div>

    <div class="container hero-content" style="position: relative; color: white; padding-top: 80px;">
        <h1 class="hero-title">{{ $supplier->business_name }}</h1>
        <p class="hero-desc">{{ $supplier->description }}</p>

        <div class="hero-meta">
            ⭐ {{ number_format($supplier->reviews_avg_rating ?? 0, 1) }}
            <span class="mx-1">•</span>
            {{ $supplier->reviews_count ?? 0 }} reviews
        </div>
    </div>
</div>

<button onclick="toggleCart()" class="floating-cart btn btn-primary btn-lg rounded-circle shadow-lg" style="width: 60px; height: 60px; position: fixed; bottom: 20px; right: 20px; z-index: 1050;">
    <i class="bi bi-cart3"></i>
    <span id="cartBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
        0
    </span>
</button>

<div class="container py-5">
    {{-- Using the grouped variable from the controller --}}
    @forelse($menuByCategory as $categoryName => $items)
        <div class="mb-5">
            <h3 class="mb-3 border-bottom pb-2">{{ $categoryName }}</h3>

            <div class="row g-4">
                @foreach($items as $item)
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm">
                            <div class="row g-0">
                                <div class="col-4">
                                    <img src="{{ $item->image_url ? asset('storage/'.$item->image_url) : asset('images/default-food.jpg') }}"
                                         class="img-fluid rounded-start"
                                         style="width:100%; height:100%; min-height:120px; object-fit:cover;"
                                         alt="{{ $item->name }}">
                                </div>

                                <div class="col-8">
                                    <div class="card-body">
                                        <h5 class="mb-1">{{ $item->name }}</h5>
                                        <p class="small text-muted mb-2">
                                            {{ Str::limit($item->description, 80) }}
                                        </p>

                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold text-primary">
                                                ${{ number_format($item->discounted_price ?? $item->price, 2) }}
                                            </span>

                                            <button 
                                                class="btn btn-sm btn-primary add-to-cart-btn"
                                                onclick="addToCart({{ $item->id }}, '{{ addslashes($item->name) }}', {{ $item->discounted_price ?? $item->price }}, '{{ $item->image_url ? asset('storage/'.$item->image_url) : asset('images/default-food.jpg') }}', {{ $item->supplier_id }})">
                                                <i class="bi bi-cart-plus"></i> Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                @endforeach
            </div>
        </div>
    @empty
        <div class="text-center py-5">
            <p class="text-muted">No menu items available for this restaurant yet.</p>
        </div>
    @endforelse
</div>

{{-- Sidebar and Overlay remain largely the same, but ensure they are included --}}
@include('partials.cart_sidebar') {{-- Or keep the HTML code you had here --}}

<script>
    // Global Constants
    const CURRENT_SUPPLIER_ID = {{ $supplier->id }};
    const MIN_ORDER_AMOUNT = 10.00;

    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function addToCart(id, name, price, image, supplierId) {
        // Check if user is trying to order from a different restaurant
        const otherSupplierItem = cart.find(item => item.supplier_id !== supplierId);
        
        if (otherSupplierItem) {
            if (!confirm("Your cart contains items from another restaurant. Would you like to clear your cart to add this item?")) {
                return;
            } else {
                cart = []; // Clear cart for new supplier
            }
        }

        const existingItem = cart.find(item => item.id === id);
        
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                id: id,
                name: name,
                price: parseFloat(price),
                image: image,
                quantity: 1,
                supplier_id: supplierId // Tagging each item
            });
        }
        
        saveCart();
        updateCart();
        showCartNotification(event);
    }

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const cartBadge = document.getElementById('cartBadge');
        const checkoutBtn = document.getElementById('checkoutBtn');
        
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        // Update UI
        cartBadge.style.display = totalItems > 0 ? 'inline-block' : 'none';
        cartBadge.textContent = totalItems;
        cartTotal.textContent = `$${total.toFixed(2)}`;
        checkoutBtn.disabled = total < MIN_ORDER_AMOUNT;
        
        // Render Cart Items
        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="text-muted text-center py-5">Your cart is empty</p>';
        } else {
            cartItems.innerHTML = cart.map(item => `
                <div class="card mb-2 border-0 border-bottom">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center">
                            <img src="${item.image}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                            <div class="flex-fill ms-2">
                                <h6 class="mb-0 small">${item.name}</h6>
                                <span class="text-primary small">$${item.price.toFixed(2)}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <button onclick="updateQuantity(${item.id}, -1)" class="btn btn-sm btn-light">-</button>
                                <span class="mx-2 small">${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, 1)" class="btn btn-sm btn-light">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    function updateQuantity(id, change) {
        const item = cart.find(i => i.id === id);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
            saveCart();
            updateCart();
        }
    }

    function showCartNotification(e) {
        const btn = e.target.closest('.add-to-cart-btn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '✓ Added';
        btn.classList.replace('btn-primary', 'btn-success');
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.replace('btn-success', 'btn-primary');
        }, 1000);
    }

    function proceedToCheckout() {
        if (cart.length > 0) {
            window.location.href = '{{ route("checkoutindex") }}';
        }
    }

    document.addEventListener('DOMContentLoaded', updateCart);
</script>

<style>
    .cart-sidebar {
        position: fixed; top: 0; right: -400px; width: 350px; height: 100%;
        background: white; z-index: 1060; transition: 0.3s; box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    .cart-sidebar.active { right: 0; }
    .cart-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: none; z-index: 1055;
    }
    .cart-overlay.active { display: block; }
</style>
@endsection
